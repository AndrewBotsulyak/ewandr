# .github/workflows/deploy-nginx.yml
name: Deploy nginx

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy (required)'
        required: true
        type: string

permissions:
  contents: read
  actions: read
  pull-requests: read

env:
  NODE_VERSION: '20'
  NX_NO_CLOUD: true
  NX_PREFER_TS_NODE: true
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY_PREFIX: ${{ secrets.ECR_REPOSITORY_PREFIX }}

jobs:
  build-and-push-nginx:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image with unique tag
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          # Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚ÐµÐ³ Ñ PR Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼ Ð¸ timestamp
          IMAGE_TAG: pr-${{ github.event.inputs.pr_number }}-${{ github.run_number }}-${{ github.sha }}
          AWS_ACCOUNT_ID: ${{ env.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}
          ECR_REPOSITORY_PREFIX: ${{ env.ECR_REPOSITORY_PREFIX }}
        run: |
          echo "Building nginx with unique tag: $IMAGE_TAG"
          echo "ECR_REGISTRY: $ECR_REGISTRY"
          echo "AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID"
          echo "AWS_REGION: $AWS_REGION"

          # Ð’ÐÐ–ÐÐž: Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ IMAGE_TAG Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÐµÐ³Ð¾ ÑƒÐ²Ð¸Ð´ÐµÐ»
          export IMAGE_TAG=$IMAGE_TAG

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð´Ð»Ñ nginx
          SCRIPT_NAME="CI_CD/ecr-nginx.sh"
          if [ -f "./$SCRIPT_NAME" ]; then
            echo "Running $SCRIPT_NAME"
            chmod +x ./$SCRIPT_NAME
            ./$SCRIPT_NAME
          else
            echo "Script $SCRIPT_NAME not found!"
            exit 1
          fi

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ð· ÑÐ¾Ð·Ð´Ð°Ð½ Ð² ECR
          echo "ðŸ” Verifying image in ECR..."
          if aws ecr describe-images \
            --repository-name "ewandr/nginx" \
            --image-ids imageTag=$IMAGE_TAG \
            --region $AWS_REGION 2>/dev/null; then
            echo "âœ… Image successfully pushed to ECR!"
          else
            echo "âŒ ERROR: Image not found in ECR after push!"
            exit 1
          fi

      - name: Clean up old ECR images
        env:
          REPO_NAME: ewandr/nginx
        run: |
          echo "ðŸ§¹ Cleaning up old ECR images for $REPO_NAME..."

          # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð², Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¾Ñ‚ ÑÐ°Ð¼Ñ‹Ñ… ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ðº ÑÐ°Ð¼Ñ‹Ð¼ Ð½Ð¾Ð²Ñ‹Ð¼
          IMAGES=$(aws ecr describe-images \
            --repository-name "$REPO_NAME" \
            --query 'sort_by(imageDetails,&imagePushedAt)[*].[imageDigest, imageTags[0], imagePushedAt]' \
            --output text)

          IMAGE_COUNT=$(echo "$IMAGES" | wc -l)
          echo "Found $IMAGE_COUNT images"

          if [ "$IMAGE_COUNT" -gt 5 ]; then
            # Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼, ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ð´Ð¾ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ñ€Ð¾Ð²Ð½Ð¾ 5
            DELETE_COUNT=$((IMAGE_COUNT - 5))
            echo "Will delete $DELETE_COUNT old images"

            # Ð‘ÐµÑ€Ñ‘Ð¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ DELETE_COUNT ÑÑ‚Ñ€Ð¾Ðº â€” ÑÑ‚Ð¾ ÑÐ°Ð¼Ñ‹Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
            IMAGES_TO_DELETE=$(echo "$IMAGES" | head -n "$DELETE_COUNT")

            echo "$IMAGES_TO_DELETE" | while read -r digest tag pushed_at; do
              [ -n "$digest" ] || continue
              echo "Deleting image with digest: $digest (tag: $tag, pushed: $pushed_at)"
              aws ecr batch-delete-image \
                --repository-name "$REPO_NAME" \
                --image-ids imageDigest="$digest" || true
            done
          else
            echo "No cleanup needed, only $IMAGE_COUNT images exist"
          fi

  update-server-configuration:
    needs: build-and-push-nginx
    if: needs.build-and-push-nginx.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts

      - name: Update .env.production with nginx tag
        env:
          SSH_KEY: ~/.ssh/lightsail_key
          REMOTE_USER: ${{ secrets.LIGHTSAIL_USER }}
          REMOTE_HOST: ${{ secrets.LIGHTSAIL_HOST }}
        run: |
          set -eo pipefail
          echo "ðŸ“ Updating server configuration with nginx image tagâ€¦"

          # 1) Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ .env.production
          ssh -i "$SSH_KEY" "$REMOTE_USER@$REMOTE_HOST" \
            "cat ~/ewandr/.env.production" > old_env_prod 2>/dev/null || true

          # 2) Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ tag - Ð¢ÐÐšÐžÐ™ Ð–Ð• ÐšÐÐš Ð’ build-and-push-nginx
          UNIQUE_TAG="pr-${{ github.event.inputs.pr_number }}-${{ github.run_number }}-${{ github.sha }}"

          # 3) ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env.production, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
          if [ -s old_env_prod ]; then
            echo "ðŸ“‹ Existing .env.production found, updating NGINX_TAG and ECR_REPOSITORY_PREFIX"
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸
            cp old_env_prod .env.production
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ NGINX_TAG
            if grep -q "^NGINX_TAG=" .env.production; then
              sed -i "s/^NGINX_TAG=.*/NGINX_TAG=$UNIQUE_TAG/" .env.production
              echo "âœ… Updated existing NGINX_TAG to $UNIQUE_TAG"
            else
              echo "NGINX_TAG=$UNIQUE_TAG" >> .env.production
              echo "âœ… Added NGINX_TAG=$UNIQUE_TAG"
            fi
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ECR_REPOSITORY_PREFIX
            if grep -q "^ECR_REPOSITORY_PREFIX=" .env.production; then
              sed -i "s/^ECR_REPOSITORY_PREFIX=.*/ECR_REPOSITORY_PREFIX=${{ env.ECR_REPOSITORY_PREFIX }}/" .env.production
              echo "âœ… Updated existing ECR_REPOSITORY_PREFIX to ${{ env.ECR_REPOSITORY_PREFIX }}"
            else
              echo "ECR_REPOSITORY_PREFIX=${{ env.ECR_REPOSITORY_PREFIX }}" >> .env.production
              echo "âœ… Added ECR_REPOSITORY_PREFIX to ${{ env.ECR_REPOSITORY_PREFIX }}"
            fi
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ECR_REGISTRY
            if grep -q "^ECR_REGISTRY=" .env.production; then
              sed -i "s/^ECR_REGISTRY=.*/ECR_REGISTRY=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/" .env.production
              echo "âœ… Updated existing ECR_REGISTRY"
            else
              echo "ECR_REGISTRY=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com" >> .env.production
              echo "âœ… Added ECR_REGISTRY"
            fi
          else
            echo "ðŸ“‹ No existing .env.production found, creating new one"
            cat > .env.production <<EOF
          # Auto-generated by GitHub Actions - nginx deployment
          # PR: #${{ github.event.inputs.pr_number }}
          # Run: #${{ github.run_number }}
          # Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ECR_REGISTRY=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          ECR_REPOSITORY_PREFIX=${{ env.ECR_REPOSITORY_PREFIX }}
          NGINX_TAG=$UNIQUE_TAG
          EOF
          fi

          # 4) ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ
          echo ""
          echo "ðŸ“‹ Updated .env.production content:"
          cat .env.production
          echo ""

          # 5) ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ Ð°Ñ‚Ð¾Ð¼Ð°Ñ€Ð½Ð¾ Ð¼ÐµÐ½ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
          scp -i "$SSH_KEY" .env.production "$REMOTE_USER@$REMOTE_HOST:~/ewandr/.env.production.new"
          ssh -i "$SSH_KEY" "$REMOTE_USER@$REMOTE_HOST" <<'ENDSSH'
          set -eo pipefail
          cd ~/ewandr
          cp .env.production .env.production.backup-$(date +%Y%m%d-%H%M%S) || true
          mv .env.production.new .env.production
          echo "âœ… .env.production successfully updated"
          cat .env.production
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/lightsail_key ./.env.production

  pull-latest-images:
    needs: [ build-and-push-nginx, update-server-configuration ]
    if: |
      needs.build-and-push-nginx.result == 'success' &&
      needs.update-server-configuration.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts

      - name: Pull latest nginx image on server
        run: |
          echo "ðŸ”„ Pulling latest nginx image on Lightsail server..."

          # SSH Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´
          ssh -i ~/.ssh/lightsail_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} << 'ENDSSH'
            set -e
            cd ~/ewandr

            echo "ðŸ“‹ Current .env.production:"
            cat .env.production

            echo "ðŸ” Logging in to AWS ECR..."
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
              docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

            echo "ðŸ“¦ Pulling nginx image"
            docker-compose --env-file .env.production -f docker-compose.prod.yml pull nginx

            echo "âœ… nginx image pulled successfully!"

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ð· Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÐºÐ°Ñ‡Ð°Ð»ÑÑ
            echo "ðŸ“Š Checking downloaded nginx image:"
            docker images | grep "nginx" | head -5
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/lightsail_key

  restart-nginx-service:
    needs: [ build-and-push-nginx, update-server-configuration, pull-latest-images ]
    if: |
      needs.build-and-push-nginx.result == 'success' &&
      needs.update-server-configuration.result == 'success' &&
      needs.pull-latest-images.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts

      - name: Restart nginx service
        run: |
          echo "ðŸ”„ Restarting nginx on Lightsail..."

          # SSH Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´
          ssh -i ~/.ssh/lightsail_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} << 'ENDSSH'
            set -e
            cd ~/ewandr

            echo "ðŸ“‹ Using .env.production:"
            cat .env.production | grep "NGINX_TAG="

            # Ð’ÐÐ–ÐÐž: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ --no-deps Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ñ‚Ñ€Ð¾Ð³Ð°Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
            echo "ðŸ›‘ Stopping nginx..."
            docker-compose --env-file .env.production -f docker-compose.prod.yml stop nginx

            echo "ðŸ—‘ï¸ Removing old container..."
            docker-compose --env-file .env.production -f docker-compose.prod.yml rm -f nginx

            echo "ðŸš€ Starting nginx with new image..."
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ --no-deps Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¢ÐžÐ›Ð¬ÐšÐž ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ
            docker-compose --env-file .env.production -f docker-compose.prod.yml up -d --no-deps nginx

            echo "â³ Waiting for container to be ready..."
            sleep 10

            echo "ðŸ“Š Checking container status..."
            docker-compose --env-file .env.production -f docker-compose.prod.yml ps nginx

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
            if docker-compose --env-file .env.production -f docker-compose.prod.yml ps nginx | grep -q "Up"; then
              echo "âœ… nginx is running!"

              # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°ÐºÐ¾Ð¹ Ð¾Ð±Ñ€Ð°Ð· Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ
              CONTAINER_ID=$(docker-compose --env-file .env.production -f docker-compose.prod.yml ps -q nginx)
              echo "ðŸ“¦ Running image:"
              docker inspect --format='{{.Config.Image}}' "$CONTAINER_ID"

              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð·Ð°Ð¿ÑƒÑÐºÐ°
              echo "ðŸ“œ Recent logs:"
              docker-compose --env-file .env.production -f docker-compose.prod.yml logs --tail=20 nginx
            else
              echo "âŒ nginx is not running properly!"
              docker-compose --env-file .env.production -f docker-compose.prod.yml logs --tail=100 nginx
              exit 1
            fi
          ENDSSH

      - name: Health check
        run: |
          echo "â³ Waiting for nginx to be fully ready..."
          sleep 30

          # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· SSH
          echo "ðŸ” Final container check..."
          ssh -i ~/.ssh/lightsail_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} \
            "cd ~/ewandr && docker-compose -f docker-compose.prod.yml ps nginx"

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/lightsail_key

  deployment-summary:
    needs: [ build-and-push-nginx, restart-nginx-service ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create deployment summary
        run: |
          echo "# ðŸš€ nginx Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** #${{ github.event.inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Nginx Application Section
          echo "## ðŸŒ nginx Application" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** ${{ needs.build-and-push-nginx.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Restart Status:** ${{ needs.restart-nginx-service.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¿Ð¾ nginx Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑŽ
          echo "### nginx" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Docker image updated" >> $GITHUB_STEP_SUMMARY
          echo "- â™»ï¸ Service restarted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Summary Statistics
          echo "## ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-and-push-nginx.result }}" == "success" ]]; then
            echo "- **nginx:** âœ… Updated and deployed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **nginx:** âŒ Failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Final Status
          echo "## ðŸŽ¯ Final Status" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build-and-push-nginx.result }}" == "success" ]] && \
             [[ "${{ needs.restart-nginx-service.result }}" == "success" ]]; then
            echo "âœ… **nginx deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **nginx deployment failed or partially completed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
